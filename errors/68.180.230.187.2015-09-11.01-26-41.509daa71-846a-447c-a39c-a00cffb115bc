(dp1
S'output'
p2
S"<type 'exceptions.ValueError'> invalid literal for long() with base 10: 'UHW'"
p3
sS'layer'
p4
S'/home/nhshd15/web2py/applications/medboard/controllers/default.py'
p5
sS'code'
p6
S'# -*- coding: utf-8 -*-\n\n##IMPORTS#####################\n#********REPORTLAB************\nfrom reportlab.platypus import *\nfrom reportlab.lib.styles import getSampleStyleSheet\nfrom reportlab.rl_config import defaultPageSize\nfrom reportlab.lib.units import inch, mm\nfrom reportlab.lib.enums import TA_LEFT, TA_RIGHT, TA_CENTER, TA_JUSTIFY\nfrom reportlab.lib import colors\nfrom uuid import uuid4\nfrom cgi import escape\nimport os\n#*************\nimport datetime\nimport requests\n##############################\n\ndef index():\n\n    return locals()\n\ndef test():\n    \n    return locals()\n\n\n@auth.requires(lambda: auth.has_membership(\'session_lead\') or auth.has_membership(\'undergrad\'))\ndef new_session():\n    #add a new session\n    #limited to members of undergrad or session_leads\n    #set the hosital field to default to the users default hospital (as per profile)\n    db.sessions.hospital.default = auth.user.default_hospital\n\n    form = SQLFORM(db.sessions,\n                   labels = {\'duration\':\'Duration (minutes)\'},\n                   col3={\'duration\':\'Please enter time in minutes\'})\n    form.vars.session_lead = auth.user_id\n    if form.process().accepted:\n        response.flash = "Session Added"\n        redirect(URL(\'my_sessions\'))\n    elif form.errors:\n        response.flash = "Errors in form. Please correct them"\n\n    return locals()\n\n@auth.requires_membership(\'session_lead\')\ndef new_repeating_session():\n    #limited to members of undergrad or session_leads\n    #this creates a basic outline then lets users enter basic session details and number of session required\n    #stores all values in a session.dictionary and redirect to a new page with a dynamically genrated SQL form\n    #the new page allows entry of dates\n    user_id = auth.user_id\n    #start from beginning\n    restrict_lead_query = ((db.auth_user.id == db.auth_membership.user_id)&\n           ((db.auth_membership.group_id == 2)|(db.auth_membership.group_id == 3)))\n\n    basic_form = SQLFORM.factory(\n                Field(\'hospital\',\'reference hospitals\',requires=IS_IN_DB(db,\'hospitals.id\',\'%(hospital_name)s - %(block_name)s\'),default=auth.user.default_hospital), #need to add a default option depending on users default hospital\n                Field(\'session_type\',\'reference session_types\',requires=IS_IN_DB(db,\'session_types.id\',\'%(session_type)s\'),default=\'1\'),    #added requires in set from SESSION_TYPES table - currently 4 types available\n                Field(\'session_lead\',\'reference auth_user\', default=auth.user_id, requires=IS_IN_DB(db(restrict_lead_query), db.auth_user.id, \'%(first_name)s %(last_name)s (%(email)s)\'),readable=False,writable=False),\n                Field(\'session_lead_name\',\'string\',requires=IS_NOT_EMPTY()),\n                Field(\'title\',\'string\',requires=IS_NOT_EMPTY()),\n                Field(\'description\',\'text\'),\n                Field(\'session_location\',\'string\',requires=IS_NOT_EMPTY()),\n                Field(\'duration\',\'integer\',requires=IS_NOT_EMPTY()),\n                Field(\'max_attendees\',\'integer\',requires=IS_NOT_EMPTY()),\n                Field(\'number_of_sessions\',\'integer\',requires=IS_NOT_EMPTY()),\n                labels = {\'duration\':\'Duration (minutes)\'},\n                submit_button=\'Next\')\n\n    if basic_form.process().accepted:\n        session.part_one = True\n        session.repeating_basic = {}\n        session.repeating_basic[\'hospital\'] = basic_form.vars.hospital\n        session.repeating_basic[\'session_type\'] = basic_form.vars.session_type\n        session.repeating_basic[\'session_lead\'] = basic_form.vars.session_lead\n        session.repeating_basic[\'session_lead_name\'] = basic_form.vars.session_lead_name\n        session.repeating_basic[\'title\'] = basic_form.vars.title\n        session.repeating_basic[\'description\'] = basic_form.vars.description\n        session.repeating_basic[\'session_location\'] = basic_form.vars.session_location\n        session.repeating_basic[\'duration\'] = basic_form.vars.duration\n        session.repeating_basic[\'max_attendees\'] = basic_form.vars.max_attendees\n        session.repeating_basic[\'number_of_sessions\'] = basic_form.vars.number_of_sessions\n\n\n        redirect(URL(\'new_repeating_session_dates\',vars={\'num\':basic_form.vars.number_of_sessions}))\n\n\n\n    return locals()\n@auth.requires_login()\ndef new_repeating_session_dates():\n    import uuid\n    user_id = int(auth.user_id)\n    uuid_value = uuid.uuid4()\n    number = request.vars.num\n    if not number:\n        session.flash = "Number of sessions not provided!"\n        redirect(URL(\'new_repeating_session\'))\n\n    number = int(number)\n\n    #make the SQL form\n    fields = []\n    for i in range(1,number+1):\n        field_name = "session_"+str(i)\n        fields.append(Field(field_name,\'datetime\',requires = IS_DATETIME(format=T(\'%d-%m-%y %H:%M\'),error_message=\'Must be dd-mm-yy HH:MM\')))\n    date_form=SQLFORM.factory(\n            *fields)\n\n\n    #process the form\n    if date_form.process().accepted:\n        for session_key in date_form.vars:\n            #date_form.vars is a dict. has a key named id and other keys named session_x\n            #we don\'t want to process the id entry\n            if session_key != \'id\':\n                #get the session date (value) for each session_x key\n                session_date = date_form.vars[session_key]\n\n                db.sessions.insert(\n                        hospital=session.repeating_basic[\'hospital\'],\n                        session_type=session.repeating_basic[\'session_type\'],\n                        session_lead=session.repeating_basic[\'session_lead\'],\n                        session_lead_name=session.repeating_basic[\'session_lead_name\'],\n#                         AUTH.SIG UPDATE> author=user_id,\n                        title=session.repeating_basic[\'title\'],\n                        description=session.repeating_basic[\'description\'],\n                        session_location=session.repeating_basic[\'session_location\'],\n                        start_datetime=session_date,\n                        duration=session.repeating_basic[\'duration\'],\n                        max_attendees=session.repeating_basic[\'max_attendees\'],\n                        current_attendees=0,\n                        repeating=True,\n                        session_active=True,\n                        session_full=False,\n                        uuid=uuid_value)\n                db.commit()\n        session.repeating_basic = {}\n        redirect(URL(\'my_sessions\'))\n    return locals()\n\n# @auth.requires_login()\ndef view_session():\n    session_id = request.vars.s_id\n    if not session_id:\n        session.flash = "No session ID provided"\n        redirect(request.env.http_referer)\n    session_record = db(db.sessions.id==session_id).select().first()\n    display_fields =[\'hospital\',\'session_type\',\'session_lead_name\',\'title\',\'description\',\'session_location\',\'start_datetime\',\'duration\',\'max_attendees\',\'attendee_ids\']\n    display_labels = {\'duration\':\'Durations (mins)\',\'max_attendees\':\'Maximum Attendees\',\'attendee_ids\':\'Currently attending\',\'session_lead_name\':\'Session Lead\'}\n\n    advanced_options=False\n    if auth:\n        user_id = auth.user_id\n        if (session_record.session_lead==user_id)or(session_record.created_by==user_id):\n            advanced_options=True\n\n    form=SQLFORM(db.sessions, session_record,\n                 readonly=True,\n                 fields=display_fields,\n                 labels=display_labels,\n                 ignore_rw=True,\n                 showid=False)\n\n    if form.process().accepted:\n        redirect(URL(\'my_sessions\'))\n    return locals()\n\n@auth.requires_login()\ndef edit_session():\n    #edit a session\n    #limited to members of undergrad or session_leads or authors\n    #undergrad should be able to add students to session manually too\n    #note think about email notifcaitons/sms\n    user_id = auth.user_id\n    session_id = request.vars.s_id\n\n    if not session_id:\n        session.flash = "No session ID provided"\n#         redirect(request.env.http_referer)\n\n    #get the session record\n    session_record = db(db.sessions.id==session_id).select().first()\n\n    #check that the user trying to make a change is either owner/author of session\n    #TODO maybe allow anyone with admisntrative/undergrad access to edit any session?\n    if (user_id != session_record.created_by) and (user_id != session_record.session_lead):\n        session.flash = "Error - you do not have permission to edit this session!"\n        redirect(request.env.http_referer)\n\n    form=SQLFORM(db.sessions, session_record, showid=False)\n    if form.process().accepted:\n            for user_id in session_record.attendee_ids:\n                #TODO test email function on \'modified_by\'\n                email_updates = send_email(user_id, "Medboard: Session Updated", session_id, "Session Details Updated")\n            session.flash = "Session Updated"\n            redirect(URL(\'my_sessions\'))\n    return locals()\n\ndef browse():\n    #visible by anyone\n    #lists ongoing sessions - default is ALL unless logged in in which case default is auth_user.default_hospital\n    #view should filter and sort etc.\n    if auth.user:\n        \n        default_hospital = get_default_hospital(auth.user.default_hospital)\n        display_name = default_hospital[\'hospital_name\']\n\n    hospital_rows = db(db.hospitals).select()\n    hospitals_list = []\n    hospitals_dict = {}\n    for row in hospital_rows:\n        hospitals_list.append(row.hospital_code + " - " + row.block_name)\n        hospitals_dict[row.id] = row.hospital_code + " - " + row.block_name\n    \n    selected_hospital = request.args(0)\n    if (not selected_hospital) and (auth.user):\n        selected_hospital = auth.user.default_hospital\n        db_selection = (db.sessions.session_active==True)&(db.sessions.hospital==selected_hospital)\n        current_hospital = get_default_hospital(selected_hospital)\n        current_hospital = current_hospital[\'hospital_code\'] + " - " + current_hospital[\'block_name\']\n        display_fields = (db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees,db.sessions.attendee_ids)\n    elif (not selected_hospital) and (not auth.user):\n        selected_hospital = \'ALL\'\n        db_selection = db.sessions.session_active==True\n        current_hospital = \'ALL\'\n        display_fields = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees,db.sessions.attendee_ids)\n    elif selected_hospital == \'ALL\':\n        db_selection = db.sessions.session_active==True\n        display_fields = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees,db.sessions.attendee_ids)\n        current_hospital = \'ALL\'\n    else:\n        hosp_id = db(db.hospitals.id==selected_hospital).select().first()\n        selected_hospital = hosp_id.id\n        db_selection = (db.sessions.session_active==True)&(db.sessions.hospital==selected_hospital)\n        current_hospital = get_default_hospital(selected_hospital)\n        current_hospital = current_hospital[\'hospital_code\'] + " - " + current_hospital[\'block_name\']\n        display_fields = (db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees,db.sessions.attendee_ids)\n\n    def status_label(row):\n        session_record = db(db.sessions.id==row.id).select().first()\n        if session_record.session_full == True:\n            return SPAN(\'FULL\',_class="label label-danger")\n        elif session_record.session_full == False:\n            if session_record.current_attendees == None:\n                current_attendees = 0\n            else:\n                current_attendees = session_record.current_attendees\n            spaces_available = session_record.max_attendees - current_attendees\n            returned_label = SPAN(SPAN(\'Spaces available\',_class="label label-success"),SPAN(\' \'),SPAN(str(spaces_available)+" / "+str(session_record.max_attendees),_class="badge"))\n            return returned_label\n\n    def sign_up_button(row):\n        attendee_ids = row.attendee_ids\n        \n        if auth.user:\n            user_id = auth.user_id\n            if user_id in attendee_ids:\n                return DIV(\'Attending\',_class="label label-success")\n            else:\n                return A(\'Sign Up\',_class="btn btn-primary",_href=URL(\'sign_up\',vars={"s_id":row.id}))\n        else:\n            return A(\'Sign Up\',_class="btn btn-primary",_href=URL(\'sign_up\',vars={"s_id":row.id}))\n\n    grid = SQLFORM.grid(db_selection,\n                        fields=display_fields,\n                        searchable=False,\n                        create=False,\n                        editable=False,\n                        deletable=False,\n                        details=False,\n                        paginate=999,\n                        sortable=False,\n                        csv=False,\n                        user_signature=False,\n                        maxtextlengths={\'sessions.hospital\':50,\'sessions.title\':50},\n                        links=[dict(header="Status",body=lambda row: status_label(row)),\n                               dict(header="Details",body=lambda row: A(\'View\',_class="btn btn-default",_href=URL(\'view_session\',vars={"s_id":row.id}))),\n                               dict(header="Sign Up",body=lambda row: sign_up_button(row))],\n                       headers={\'sessions.start_datetime\':"Start Date and Time",\'sessions.duration\':\'Duration (mins)\'}\n                       )\n\n    if grid.element(\'table\'): grid.element(\'table\')[\'_id\'] = \'data_table\' #giving an id to the grid container for datatables JS to know what to target\n\n    return locals()\n\n@auth.requires_login()\ndef sign_up():\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    session_record = db(db.sessions.id==session_id).select().first()\n    if not session_id:\n        session.flash = "No session ID provided"\n        redirect(request.env.http_referer)\n\n\n    #get number and ids of people already signed up\n    number_of_attendees = session_record.current_attendees\n    current_attendee_ids = session_record.attendee_ids  #get ids of people already signed up\n\n    #ensure user trying to sign up is not session_lead\n    if session_record.session_lead == user_id:\n        session.flash = \'You are the lead for this session. You cannot sign up.\'\n        redirect((request.env.http_referer) or (URL(\'browse\')))\n    elif session_record.created_by == user_id:\n        session.flash = \'You are the author of this session. You cannot sign up.\'\n        redirect((request.env.http_referer) or (URL(\'browse\')))\n    elif user_id in session_record.attendee_ids:\n        session.flash = \'You are already signed up. Thanks!\'\n        redirect((request.env.http_referer) or (URL(\'browse\')))\n    elif session_record.session_full ==  True:\n        session.flash = \'Sorry, this session is full!\'\n        redirect((request.env.http_referer) or (URL(\'browse\')))\n    else:\n        #perform operations to add current user to list and increment total by 1\n        current_attendee_ids.append(user_id)\n        number_of_attendees += 1\n\n        #make datebase updates\n        session_record.update_record(attendee_ids=current_attendee_ids)\n        session_record.update_record(current_attendees=number_of_attendees)\n\n        #if we now reached the max number of attendees then flip the switch to full\n        if number_of_attendees == session_record.max_attendees:\n            session_record.update_record(session_full=True)\n\n        session.flash = "Thanks for signing up"\n        redirect(URL(\'my_sessions\'))\n    return locals()\n\n@auth.requires_login()\ndef remove_from_session(session_id, user_id):\n\n    #GET THE CURRENT RECORD, ATTENDEE LIST AND NUMBER OF ATTENDEES\n    session_record = db(db.sessions.id==session_id).select().first()\n    attendee_list = session_record.attendee_ids\n    current_attendees = session_record.current_attendees\n    removal_status ="NotRemoved"\n#     #check that the user_id is in listed as currently attending this session\n    if user_id not in session_record.attendee_ids:\n        removal_status = "NotInList"\n    else:\n        #IF SESSSION IF CURRENTLY FULL THEN SWITCH TO NOT FULL\n        #(AS ONCE THIS USER QUITS THERE WILL BE ONE MORE SPACE)\n        if session_record.session_full==True:\n            session_record.update_record(session_full=False)\n\n        #SUBTRACT ONE USER FROM NUMBERS\n        current_attendees -= 1\n        session_record.update_record(current_attendees=current_attendees)\n\n        #REMOVE USER ID FROM ATTENDEE IDs\n        attendee_list.remove(user_id)\n        session_record.update_record(attendee_ids=attendee_list)\n        removal_status = "Removed"\n    return removal_status\n\n@auth.requires_login()\ndef quit_session():\n    #GET VARS\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    session_record = db(db.sessions.id==session_id).select(db.sessions.repeating).first()\n    if not session_id:\n        session.flash = "No session ID provided"\n        redirect(request.env.http_referer)\n    \n    #disabled leave repeaeting session\n#     if session_record.repeating:\n#         redirect(URL(\'quit_repeating_session\',vars={"s_id":session_id}))\n#     else:\n    removal_status = remove_from_session(session_id, user_id)\n    if removal_status == "Removed":\n        session.flash = "You have been removed from the session"\n    elif removal_status == "NotInList":\n        session.flash = "You are not listed as being signed up to this session."\n    else:\n        session.flash = "Error. You have not been removed from the session"\n    redirect(URL(\'my_sessions\'))\n\n    return locals()\n\n@auth.requires_login()\ndef quit_repeating_session():\n    #GET VARS\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    if not session_id:\n        session.flash = "No session ID provided"\n        redirect(request.env.http_referer)\n    session_record = db(db.sessions.id==session_id).select().first()\n\n    #layout options for grid\n    display_fields = (db.sessions.title,db.sessions.start_datetime)\n    field_headers = {\'sessions.start_datetime\':"Start Date and Time"}\n    #get any other records with same UUID and display in grid\n    grid = SQLFORM.grid((db.sessions.attendee_ids.contains(user_id))&(db.sessions.uuid==session_record.uuid),\n                        selectable = lambda ids : redirect(URL(\'default\', \'remove_from_repeating\', vars=dict(s_id=ids))),\n                        fields=display_fields,\n                        headers=field_headers,\n                        searchable=False,\n                        create=False,\n                        editable=False,\n                        deletable=False,\n                        csv=False,\n                       details=False)\n    \n    return locals()\n\n@auth.requires_login()\ndef remove_from_repeating():\n    session_ids = request.vars.s_id\n    user_id = auth.user_id\n    if not session_ids:\n        redirect(URL(\'my_sessions\'))\n        session.flash = "Please try again. Remember to tick the boxes of sessions you want to leave"\n    else:\n        for id in session_ids:\n            removal_status = remove_from_session(id, user_id)\n        redirect(URL(\'my_sessions\'))\n        session.flash = "Sucessfully removed from selected session(s)"\n    return locals()\n\n@auth.requires_login()\ndef cancel_session():\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    is_owner = check_if_owner(session_id, user_id)\n    if is_owner:\n        session_record = db(db.sessions.id==session_id).select().first()\n        if session_record.session_active == False:\n            session.flash = "Session already cancelled"\n            redirect(URL(\'my_sessions\'))\n        elif session_record.repeating:\n            redirect(URL(\'cancel_repeating_session\',vars={"s_id":session_id}))\n        else:\n            session_record.update_record(session_active=False)\n            #TODO >>>>>>>>>> SEND EMAIL UPDATE TO SIGNED UP USERS\n            session.flash = "Session cancelled"\n            redirect(URL(\'my_sessions\'))\n    else:\n        session.flash = "You are not authorised to cancel this session."\n        redirect(URL(\'my_sessions\'))\n\n    return locals()\n\n@auth.requires_login()\ndef cancel_repeating_session():\n    #GET VARS\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    is_owner = check_if_owner(session_id, user_id)\n    if is_owner:\n        session_record = db(db.sessions.id==session_id).select().first()\n\n        #layout options for grid\n        display_fields = (db.sessions.title,db.sessions.start_datetime)\n        field_headers = {\'sessions.start_datetime\':"Start Date and Time"}\n        #get any other records with same UUID and display in grid\n\n        grid = SQLFORM.grid(db.sessions.uuid==session_record.uuid,\n                            selectable = lambda ids : redirect(URL(\'default\', \'cancel_repeating\', vars=dict(s_id=ids))),\n                            fields=display_fields,\n                            headers=field_headers,\n                            searchable=False,\n                            create=False,\n                            editable=False,\n                            deletable=False,\n                            csv=False,\n                            details=False\n                            )\n        return locals()\n    \n@auth.requires_login()\ndef cancel_repeating():\n    session_ids = request.vars.s_id\n    user_id = auth.user_id\n    if not session_ids:\n        redirect(URL(\'my_sessions\'))\n        session.flash = "Please try again. Remember to tick the boxes of sessions you want to leave"\n    else:\n        for id in session_ids:\n            session_record = db(db.sessions.id==id).select().first()\n            session_record.update_record(session_active=False)\n            ###TODO SEND EMAIL UPDATE TO SIGNED UP USERS\n        redirect(URL(\'my_sessions\'))\n        session.flash = "Sucessfully cancelled selected session(s)"\n    return locals()\n\n@auth.requires_login()\ndef enable_session():\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    is_owner = check_if_owner(session_id, user_id)\n    now = datetime.datetime.now()\n    if is_owner:\n        session_record = db(db.sessions.id==session_id).select().first()\n        if session_record.session_active == True:\n            session.flash = "Session already enabled"\n            redirect(URL(\'my_sessions\'))\n        elif session_record.start_datetime < now:\n            session.flash = "Session datetime is in the past. Please update this before enabling"\n            redirect(URL(\'my_sessions\'))\n\n        else:\n            session_record.update_record(session_active=True)\n            #TODO >>>>>>>>>> SEND EMAIL UPDATE TO SIGNED UP USERS\n            session.flash = "Session enabled"\n            redirect(URL(\'my_sessions\'))\n    else:\n        session.flash = "You are not authorised to enable this session."\n        redirect(URL(\'my_sessions\'))\n\n    return locals()\n@auth.requires_login()\ndef my_sessions():\n\n    user_id = auth.user_id\n    default_sort=[db.sessions.start_datetime]\n#     display_fields = (db.sessions.hospital,db.sessions.session_type,db.sessions.session_lead,db.sessions.title,db.sessions.start_datetime)\n    display_fields_upcoming = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name)\n    display_fields_previous = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name)\n    display_fields_lead = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_active)\n    display_fields_authored = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_active)\n    field_headers = {\'sessions.start_datetime\':"Start Date and Time"}\n\n    #custom links in extra columns\n    def session_status(row):\n        if row.session_active == True:\n            return SPAN(\'Enabled\',_class="label label-success")\n        elif row.session_active == False:\n            return SPAN(\'Disabled\',_class="label label-danger")\n    def button_options(row):\n        if row.session_active == True:\n            return A(\'Disable\',_class="btn btn-danger",_href=URL(\'cancel_session\',vars={"s_id":row.id}))\n        elif row.session_active == False:\n            return A(\'Enable\',_class="btn btn-success",_href=URL(\'enable_session\',vars={"s_id":row.id}))\n\n    links_current=[dict(header="Details",body=lambda row: A(\'View\',_class="btn btn-default",_href=URL(\'view_session\',vars={"s_id":row.id}))),\n                   dict(header="Leave",body=lambda row: A(\'Leave Session\',_class="btn btn-danger",_href=URL(\'quit_session\',vars={"s_id":row.id})))]\n    links_previous=[dict(header="Details",body=lambda row: A(\'View\',_class="btn btn-default",_href=URL(\'view_session\',vars={"s_id":row.id}))),\n                    dict(header="Feedback",body=lambda row: A(\'Provide Feedback\',_class="btn btn-primary",_href=URL(\'feedback\',vars={"s_id":row.id})))]\n    links_authored=[dict(header="Status",body=lambda row: session_status(row)),\n                    dict(header="Details",body=lambda row: A(\'View\',_class="btn btn-default",_href=URL(\'view_session\',vars={"s_id":row.id}))),\n                    dict(header="Edit",body=lambda row: A(\'Edit\',_class="btn btn-info",_href=URL(\'edit_session\',vars={"s_id":row.id}))),\n                    dict(header="Print Report",body=lambda row: A(\'Print Report\',_class="btn btn-info",_href=URL(\'print_session_report\',vars={"s_id":row.id}))),\n                    dict(header="Change Status",body=lambda row: button_options(row))]\n    links_lead=[dict(header="Status",body=lambda row: session_status(row)),\n                    dict(header="Details",body=lambda row: A(\'View\',_class="btn btn-default",_href=URL(\'view_session\',vars={"s_id":row.id}))),\n                    dict(header="Edit",body=lambda row: A(\'Edit\',_class="btn btn-info",_href=URL(\'edit_session\',vars={"s_id":row.id}))),\n                    dict(header="Print Report",body=lambda row: A(\'Print Report\',_class="btn btn-info",_href=URL(\'print_session_report\',vars={"s_id":row.id}))),\n                    dict(header="Change Status",body=lambda row: button_options(row))]\n\n\n#     links_current=[dict(header="",body=lambda row: A(\'Leave Session\',_class="btn btn-danger",_name="row1",_onclick="ajax(\'quit_session\',[\'row1\'],\'target\'"))]   - tried with ajax, didnt work\n    #get all current sessions\n    upcoming_sessions = SQLFORM.grid(\n                                    (db.sessions.attendee_ids.contains(user_id))&(db.sessions.session_active==True),\n                                    fields=display_fields_upcoming,\n                                    links=links_current,\n                                    headers=field_headers,\n                                    searchable=False,\n                                    create=False,\n                                    editable=False,\n                                    deletable=False,\n                                    csv=False,\n                                    details=False,\n                                    sortable=False,\n                                    maxtextlengths={\'sessions.hospital\' : 100,\'sessions.title\':100})\n\n\n    #get old sessions\n    previous_sessions = SQLFORM.grid(\n                                    (db.sessions.attendee_ids.contains(user_id))&(db.sessions.session_active==False),\n                                    fields=display_fields_previous,\n                                    links=links_previous,\n                                    headers=field_headers,\n                                    searchable=False,\n                                    create=False,\n                                    editable=False,\n                                    deletable=False,\n                                    csv=False,\n                                    details=False,\n                                    sortable=False,\n                                    maxtextlengths={\'sessions.hospital\' : 100,\'sessions.title\':100})\n\n\n    #get sessions that user authored\n    authored_sessions = SQLFORM.grid(db.sessions.created_by==user_id,\n                                    fields=display_fields_authored,\n                                    links=links_authored,\n                                    headers=field_headers,\n                                    searchable=False,\n                                    create=False,\n                                    editable=False,\n                                    deletable=False,\n                                    csv=False,\n                                    details=False,\n                                    sortable=False,                                     \n                                    maxtextlengths={\'sessions.hospital\' : 100,\'sessions.title\':100})\n\n    #get sessions that user led\n    leader_sessions = SQLFORM.grid(db.sessions.session_lead==user_id,\n                                    fields=display_fields_lead,\n                                    links=links_lead,\n                                    headers=field_headers,\n                                    searchable=False,\n                                    create=False,\n                                    editable=False,\n                                    deletable=False,\n                                    csv=False,\n                                    details=False,\n                                    sortable=False,                                   \n                                    maxtextlengths={\'sessions.hospital\' : 100,\'sessions.title\':100})\n\n    if upcoming_sessions.element(\'table\'): upcoming_sessions.element(\'table\')[\'_id\'] = \'data_table_upcoming\' #giving an id to the grid container for datatables JS to know what to target\n    if previous_sessions.element(\'table\'): previous_sessions.element(\'table\')[\'_id\'] = \'data_table_previous\' #giving an id to the grid container for datatables JS to know what to target\n    if leader_sessions.element(\'table\'): leader_sessions.element(\'table\')[\'_id\'] = \'data_table_leader\' #giving an id to the grid container for datatables JS to know what to target\n    if authored_sessions.element(\'table\'): authored_sessions.element(\'table\')[\'_id\'] = \'data_table_authored\' #giving an id to the grid container for datatables JS to know what to target\n\n\n    return dict(user_id=user_id,upcoming_sessions=upcoming_sessions,previous_sessions=previous_sessions,authored_sessions=authored_sessions,leader_sessions=leader_sessions)\n\n@auth.requires_login()\ndef feedback():\n    user_id = auth.user_id\n    session_id = request.vars.s_id\n    session_record = db(db.sessions.id==session_id).select().first()\n    current_feedback_records = db(db.feedback.session_id==session_id).select()\n    feedback_completed = False\n    #check if the user already has a feedback record for this session\n    #if so set feedback_completed to True to do allow record update rather than new record\n    for record in current_feedback_records:\n        if user_id == record.user_id:\n            feedback_id = record.id\n            feedback_record = db(db.feedback.id==feedback_id).select().first()\n            feedback_completed = True\n\n    session_form=SQLFORM(db.sessions, session_record,\n             readonly=True,\n             showid=False)\n    current_attendee_ids = session_record.attendee_ids  #get ids of people already signed up\n\n    if user_id not in session_record.attendee_ids:\n        feedback_form = None\n        session.flash = \'You can\\\'t leave feedback because you didn\\\'t sign up to this session.\'\n        redirect(URL(\'my_sessions\'))\n    else:\n        if feedback_completed:\n            session.flash = \'You already completed a feedback form. You can update it below.\'\n            feedback_form = SQLFORM(db.feedback, feedback_record, submit_button="Update",\n                                    labels={\'rate_interesting\':\'Interesting (1=poor,10=excellent)\',\n                                    \'rate_relevance\':\'Relevance  (1=poor,10=excellent)\',\n                                    \'rate_teaching\':\'Teaching Quality  (1=poor,10=excellent)\',\n                                    \'rate_overall\':\'Overall Rating  (1=poor,10=excellent)\',\n                                    \'rate_confidence\':\'Has your confidence with this subject improved?\'},\n                                    showid=False)\n        else:\n            feedback_form = SQLFORM(db.feedback,\n                            labels={\'rate_interesting\':\'Interesting (1=poor,10=excellent)\',\n                                    \'rate_relevance\':\'Relevance  (1=poor,10=excellent)\',\n                                    \'rate_teaching\':\'Teaching Quality  (1=poor,10=excellent)\',\n                                    \'rate_overall\':\'Overall Rating  (1=poor,10=excellent)\',\n                                    \'rate_confidence\':\'Has your confidence with this subject improved?\'})\n        feedback_form.vars.session_id = session_id\n        feedback_form.vars.user_id = user_id\n\n        if feedback_form.process().accepted:\n            session.flash = "Thanks for your feedback!"\n            redirect(URL(\'my_sessions\'))\n\n\n\n    return locals()\n\n@auth.requires(lambda: auth.has_membership(\'hospital\') or auth.has_membership(\'undergrad\') or auth.has_membership(\'administrator\'))\ndef admin_page():\n    if not request.vars.db_name:\n        requested_page = "access_keys"        \n    else:\n        requested_page = request.vars.db_name\n\n\n    if requested_page=="hospitals":\n        query = db.hospitals\n        display_fields = (db.hospitals.hospital_name,db.hospitals.hospital_code,db.hospitals.block_name)\n        additional_links = None\n    elif requested_page=="sessions":\n        query = db.sessions\n        display_fields = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees)\n        additional_links = None\n    elif requested_page=="session_types":\n        query = db.session_types\n        display_fields = (db.session_types.id, db.session_types.session_type)\n        additional_links = None\n\n    elif requested_page=="access_keys":\n        query = db.access_keys\n        display_fields = (db.access_keys.unique_key,db.access_keys.key_active,db.access_keys.access_level)\n        additional_links = None\n\n    elif requested_page=="print_reports":\n        query = db.sessions\n        display_fields = (db.sessions.hospital,db.sessions.session_type,db.sessions.title,db.sessions.start_datetime,db.sessions.session_lead_name,db.sessions.session_full,db.sessions.current_attendees)\n        additional_links = [dict(header="Print Report",body=lambda row: A(\'Print Report\',_class="btn btn-info",_href=URL(\'print_session_report\',vars={"s_id":row.id})))]\n    elif requested_page=="users":\n        query = db.auth_user\n        display_fields = (db.auth_user.first_name,db.auth_user.last_name,db.auth_user.email,db.auth_user.default_hospital,db.auth_user.access_key)\n        additional_links = [dict(header="Print Report",body=lambda row: A(\'Print Report\',_class="btn btn-info",_href=URL(\'print_user_report\',vars={"u_id":row.id})))]\n    grid = SQLFORM.grid(query,\n                        searchable=False,\n                        create=True,\n                        editable=True,\n                        deletable=False,\n                        details=True,\n                        paginate=999,\n                        sortable=True,\n                        csv=False,\n                        user_signature=False,\n                        maxtextlength=30,\n                        fields=display_fields,\n                        links=additional_links\n#                         maxtextlengths={\'sessions.hospital\' : 100,\'sessions.title\':100}\n                       )\n    if grid.element(\'table\'): grid.element(\'table\')[\'_id\'] = \'data_table\'\n\n    return locals()\n\ndef check_if_owner(session_id, user_id):\n    session_record = db(db.sessions.id==session_id).select().first()\n    if session_record.session_lead == user_id:\n        return True\n    elif session_record.created_by == user_id:\n        return True\n    else:\n        return False\n    \n    \ndef send_email(user_id, subject, session_id, message):\n\n    #first check if user wants to recieve updates\n    user_record = db(db.auth_user.id==user_id).select().first()\n    session_record = db(db.sessions.id==session_id).select().first()\n    result = 999\n    if user_record.email_notifications:\n        email_name = get_name_by_id(user_id)\n        email_address = user_record.email\n        email_subject = subject\n        email_message = message\n        message_text= "Medboard.co.uk \\n Hello this is an email from Medboard.co.uk. \\n Please see the the message below: \\n" + str(message) + "\\n This message is related to the following session: \\n Session title: " + str(session_record.title) + "\\n Session Date: \\n" + str(session_record.start_datetime.strftime(\'%d-%m-%Y %H:%M\')) \n        message_html = "<h1>Medboard.co.uk</h1> <p>Hello. This is an email from Medboard.co.uk. Please see the message below: </p> <hr> <h3>" + email_message + "</h3> <hr> <p>This message is related to the following session:</p> <p>Session Title: " + str(session_record.title) + "</p> <p>Session Date and Time: " + str(session_record.start_datetime.strftime(\'%d-%m-%Y %H:%M\')) + "</p> <p><a href=\'http://nhshd15.pythonanywhere.com/medboard/default/view_session?s_id="+str(session_id)+"\'>Click here</a> to view this session\'s details</p> <p><a href=\'http://nhshd15.pythonanywhere.com/medboard/default/my_sessions\'>Click here</a> to view all your sessions. </p> "\n\n        send_email = requests.post(\n            "https://api.mailgun.net/v3/medboard.co.uk/messages",\n            auth=("api", "key-bb2f721881bfc7b739162a54a291f281"),\n            data={"from": "Medboard.co.uk <medboard.mail@gmail.com>",\n                  "to": email_name + "<" + email_address + ">",\n                  "subject": "Session Updated",\n                  "text": message_text,\n                  "html": message_html})\n    \n        if send_email.status_code == 200:\n            result = send_email.status_code\n        \n    return result\n\n\ndef get_default_hospital(hosp_id):\n    #function to get the users deafualt hosputal details from the hospitals table\n    #requires a hospital ID to be passed\n    #returns a dictionary with full name and 3 letter code\n    row = db.hospitals[hosp_id]\n#     the above line does the same as this line below but is far shorter\n#     row = db(db.hospitals.id==hosp_id).select().first()\n    users_hospital = {"hospital_name":row.hospital_name,"hospital_code":row.hospital_code,"block_name":row.block_name}\n    return users_hospital\n\ndef export_as_pdf():\n    #will pass it text or something\n    #use generic.pdf\n    #implementation of pyFPDF\n    #v.easy to use: https://code.google.com/p/pyfpdf/wiki/Tutorial\n    return locals()\n\ndef get_me_a_pdf():\n\ttitle = "This The Doc Title"\n\theading = "First Paragraph"\n\ttext = \'bla \'* 10000\n\tstyles = getSampleStyleSheet()\n\ttmpfilename=os.path.join(request.folder,\'private\',str(uuid4()))\n\tdoc = SimpleDocTemplate(tmpfilename)\n\tstory = []\n\tstory.append(Paragraph(escape(title),styles["Title"]))\n\tstory.append(Paragraph(escape(heading),styles["Heading2"]))\n\tstory.append(Paragraph(escape(text),styles["Normal"]))\n\tstory.append(Spacer(1,2*inch))\n\tdoc.build(story)\n\tdata = open(tmpfilename,"rb").read()\n\tos.unlink(tmpfilename)\n\tresponse.headers[\'Content-Type\']=\'application/pdf\'\n\treturn data\n\ndef get_name_by_id(user_id):\n    user_record = db(db.auth_user.id==user_id).select().first()\n    first_name = user_record.first_name\n    last_name = user_record.last_name\n    full_name = str(first_name +" " + last_name)\n    return full_name\n\ndef get_type_by_id(session_type_id):\n    type_record = db(db.session_types.id==session_type_id).select().first()\n    type_name = str(type_record.session_type)\n    return type_name\n\ndef get_hospital_by_id(hospital_id):\n    hospital_record = db(db.hospitals.id==hospital_id).select().first()\n    hospital_name = str(hospital_record.hospital_name + " - " + hospital_record.block_name)\n    return hospital_name\n\ndef failed_auth():\n\n    return locals()\n\ndef about():\n\n    return locals()\n\ndef help():\n\n    return locals()\n\ndef access_key():\n    access_key = request.vars.access_key\n    user_id = auth.user_id\n    if access_key:\n        form = "Access key processed"\n        user_record = db(db.auth_user.id==user_id).select().first()\n        user_record.update_record(access_key=access_key)\n\n        #copypasted from db1.py\n        user_key = access_key\n        access_keys = db(db.access_keys.key_active==True).select()\n        for single_key in access_keys:\n            if single_key.unique_key == user_key:\n                access_level = single_key.access_level\n                if access_level == \'session_lead\':\n                    auth.add_membership(2, user_id)\n                elif access_level == \'undergrad\':\n                    auth.add_membership(3, user_id)\n                elif access_level == \'hospital\':\n                    auth.add_membership(4, user_id)\n                elif access_level == \'administrator\':\n                    auth.add_membership(5, user_id)\n        session.flash = "Access key processed"\n        redirect(URL(\'my_sessions\'))\n\n    else:\n        form = SQLFORM.factory(\n            Field(\'access_key\',\'string\'))\n        if form.process().accepted:\n            redirect(URL(\'access_key\',vars={\'access_key\':form.vars.access_key}))\n    return locals()\n\n@auth.requires_login()\ndef unsubscribe_email():\n    user_id = auth.user_id\n    user_record = db(db.auth_user.id==user_id).select().first()\n    \n    user_record.update_record(email_notifications=False)\n    session.flash="Ubsubscribed from emails"\n    redirect(URL("user",args=[\'profile\']))\n    \n    return locals()\n\n    \n    \ndef print_session_report():\n    session_id = request.vars.s_id\n    user_id = auth.user_id\n    session_record = db(db.sessions.id==session_id).select().first()\n\n    styles = getSampleStyleSheet()\n    tmpfilename=os.path.join(request.folder,\'private\',str(uuid4()))\n    doc = SimpleDocTemplate(tmpfilename)\n    story = []\n\n    title = "Medboard: Session Report - " + session_record.title\n    story.append(Paragraph(escape(title),styles["Title"]))\n\n    heading = "Session Details"\n    story.append(Paragraph(escape(heading),styles["Heading2"]))\n\n    session_lead = "Session Lead: " + session_record.session_lead_name\n    story.append(Paragraph(escape(session_lead),styles["Heading4"]))\n\n    session_type = "Session Type: " + get_type_by_id(session_record.session_type)\n    story.append(Paragraph(escape(session_type),styles["Heading4"]))\n\n    hospital_name = "Hospital Name: " + get_hospital_by_id(session_record.hospital)\n    story.append(Paragraph(escape(hospital_name),styles["Heading4"]))\n\n    session_location = "Session Location: " + (session_record.session_location)\n    story.append(Paragraph(escape(session_location),styles["Heading4"]))\n\n    date = "Date of session: " + str(session_record.start_datetime)\n    story.append(Paragraph(escape(date),styles["Heading4"]))\n\n    duration = "Duration (mins): " + str(session_record.duration)\n    story.append(Paragraph(escape(duration),styles["Heading4"]))\n\n    if session_record.description:\n        description = "Description: " + session_record.description\n        story.append(Paragraph(escape(description),styles["Normal"]))\n\n    heading = "Attendee Details"\n    story.append(Paragraph(escape(heading),styles["Heading2"]))\n\n\n    attendees = "Attendees: " + str(session_record.current_attendees) + " / " + str(session_record.max_attendees)\n    story.append(Paragraph(escape(attendees),styles["Normal"]))\n\n    story.append(Paragraph(escape("Names"),styles["Heading5"]))\n    for attendee_id in session_record.attendee_ids:\n        full_name = u"\\u2022" + " "  + get_name_by_id(attendee_id)\n        story.append(Paragraph(escape(full_name),styles["Normal"]))\n\n    heading = "Feedback"\n    story.append(Paragraph(escape(heading),styles["Heading2"]))\n\n    #GET FEEDBACK RECORDS\n    feedback_records = db(db.feedback.session_id==session_id).select()\n    total_feedback_records = len(feedback_records)\n\n    if total_feedback_records == 0:\n        story.append(Paragraph(escape("No feedback yet"),styles["Normal"]))\n    else:\n        #AVERAGE RATING SECTION\n        story.append(Paragraph(escape("Average Ratings"),styles["Heading5"]))\n        total_interesting = 0\n        total_relevance = 0\n        total_teaching = 0\n        total_overall = 0\n        for record in feedback_records:\n            total_interesting += record.rate_interesting\n            total_relevance += record.rate_relevance\n            total_teaching += record.rate_teaching\n            total_overall += record.rate_overall\n        avg_interesting = total_interesting / total_feedback_records\n        story.append(Paragraph(escape("-- Interesting: " + str(avg_interesting) + "/10"  ),styles["Normal"]))\n        avg_relevance = total_relevance / total_feedback_records\n        story.append(Paragraph(escape("-- Relevance: " + str(avg_relevance) + "/10"  ),styles["Normal"]))\n        avg_teaching = total_teaching / total_feedback_records\n        story.append(Paragraph(escape("-- Teaching Quality: " + str(avg_teaching) + "/10"  ),styles["Normal"]))\n        avg_overall = total_overall / total_feedback_records\n        story.append(Paragraph(escape("-- Overall: " + str(avg_overall) + "/10"  ),styles["Normal"]))\n\n        #FEEDBACK COMMENTS\n        story.append(Paragraph(escape("Comments"),styles["Heading5"]))\n        story.append(Paragraph(escape("Positive Points"),styles["Normal"]))\n        for record in feedback_records:\n            if (record.positive_points) and (record.positive_points != ""):\n                story.append(Paragraph(escape("-- " + record.positive_points),styles["Normal"]))\n\n        #spacer  - change 0.1 to desired value (0.1 is like a line break)\n        story.append(Spacer(1,0.1*inch))\n\n        story.append(Paragraph(escape("Negative Points"),styles["Normal"]))\n        for record in feedback_records:\n            if (record.negative_points) and (record.negative_points != ""):\n                story.append(Paragraph(escape("-- " + record.negative_points),styles["Normal"]))\n\n        story.append(Spacer(1,0.1*inch))\n\n        story.append(Paragraph(escape("Points for Improvement"),styles["Normal"]))\n        for record in feedback_records:\n            if (record.improvements) and (record.improvements != ""):\n                story.append(Paragraph(escape("-- " + record.improvements),styles["Normal"]))\n\n\n    story.append(Spacer(1,2*inch))\n    doc.build(story)\n    data = open(tmpfilename,"rb").read()\n    os.unlink(tmpfilename)\n    response.headers[\'Content-Type\']=\'application/pdf\'\n    return data\n\ndef print_user_report():\n    user_id = request.vars.u_id\n    user_record = db(db.auth_user.id==user_id).select().first()\n    sessions_attended = db(db.sessions.attendee_ids.contains(user_id)).select()\n    \n    styles = getSampleStyleSheet()\n    tmpfilename=os.path.join(request.folder,\'private\',str(uuid4()))\n    doc = SimpleDocTemplate(tmpfilename)\n    story = []\n\n    title = "Medboard: User Report - " + user_record.first_name + " " + user_record.last_name\n    story.append(Paragraph(escape(title),styles["Title"]))\n\n    heading = "User Details"\n    story.append(Paragraph(escape(heading),styles["Heading2"]))\n\n    user_name = "User Name: " + get_name_by_id(user_id)\n    story.append(Paragraph(escape(user_name),styles["Heading4"]))\n\n    user_email = "Email: " + user_record.email\n    story.append(Paragraph(escape(user_email),styles["Heading4"]))\n\n    default_hospital = "Default Hospital: " + get_hospital_by_id(user_record.default_hospital)\n    story.append(Paragraph(escape(default_hospital),styles["Heading4"]))\n\n    date_of_report = "Date of report: " + str(datetime.datetime.today().strftime(\'%d %b %Y\'))\n    story.append(Paragraph(escape(date_of_report),styles["Heading4"]))\n\n\n    sessions_attended_count = "Sessions Attended: "  + str(len(sessions_attended))\n    story.append(Paragraph(escape(sessions_attended_count),styles["Heading2"]))\n\n\n    story.append(Paragraph(escape("Session Breakdown"),styles["Heading2"]))\n    session_types = db(db.session_types).select()\n    for session_type in session_types:\n        type_name = get_type_by_id(session_type)\n        story.append(Paragraph(escape(type_name),styles["Heading3"]))\n\n        for session in sessions_attended:\n            if session.session_type == session_type:\n                session_detail = session.title + " / " + session.session_location + " / " + str(session.start_datetime.strftime(\'%d-%m-%Y %H:%M\')) + " / " + str(session.duration) + "mins / " + get_name_by_id(session.session_lead_name)\n                story.append(Paragraph(escape(session_detail),styles["Normal"]))\n        story.append(Spacer(1,0.1*inch))\n\n    story.append(Spacer(1,2*inch))\n    doc.build(story)\n    data = open(tmpfilename,"rb").read()\n    os.unlink(tmpfilename)\n    response.headers[\'Content-Type\']=\'application/pdf\'\n    return data\ndef user():\n    """\n    exposes:\n    http://..../[app]/default/user/login\n    http://..../[app]/default/user/logout\n    http://..../[app]/default/user/register\n    http://..../[app]/default/user/profile\n    http://..../[app]/default/user/retrieve_password\n    http://..../[app]/default/user/change_password\n    http://..../[app]/default/user/manage_users (requires membership in\n    use @auth.requires_login()\n        @auth.requires_membership(\'group name\')\n        @auth.requires_permission(\'read\',\'table name\',record_id)\n    to decorate functions that need access control\n    """\n\n    return dict(form=auth())\n\n\n@cache.action()\ndef download():\n    """\n    allows downloading of uploaded files\n    http://..../[app]/default/download/[filename]\n    """\n    return response.download(request, db)\n\n\ndef call():\n    """\n    exposes services. for example:\n    http://..../[app]/default/call/jsonrpc\n    decorate with @services.jsonrpc the functions to expose\n    supports xml, json, xmlrpc, jsonrpc, amfrpc, rss, csv\n    """\n    return service()\n\n\n@auth.requires_login()\ndef api():\n    """\n    this is example of API with access control\n    WEB2PY provides Hypermedia API (Collection+JSON) Experimental\n    """\n    from gluon.contrib.hypermedia import Collection\n    rules = {\n        \'<tablename>\': {\'GET\':{},\'POST\':{},\'PUT\':{},\'DELETE\':{}},\n        }\n    return Collection(db).process(request,response,rules)\n\nresponse._vars=response._caller(browse)\n'
p7
sS'snapshot'
p8
(dp9
sS'traceback'
p10
S'Traceback (most recent call last):\n  File "/home/nhshd15/web2py/gluon/restricted.py", line 227, in restricted\n    exec ccode in environment\n  File "/home/nhshd15/web2py/applications/medboard/controllers/default.py", line 1090, in <module>\n  File "/home/nhshd15/web2py/gluon/globals.py", line 393, in <lambda>\n    self._caller = lambda f: f()\n  File "/home/nhshd15/web2py/applications/medboard/controllers/default.py", line 235, in browse\n    hosp_id = db(db.hospitals.id==selected_hospital).select().first()\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/objects.py", line 2026, in select\n    return adapter.select(self.query,fields,attributes)\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/sqlite.py", line 125, in select\n    return super(SQLiteAdapter, self).select(query, fields, attributes)\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 1226, in select\n    sql = self._select(query, fields, attributes)\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 1124, in _select\n    sql_w = \' WHERE \' + self.expand(query) if query else \'\'\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 909, in expand\n    out = op(first, second, **optional_args)\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 806, in EQ\n    self.expand(second, first.type))\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 920, in expand\n    return str(self.represent(expression,field_type))\n  File "/home/nhshd15/web2py/gluon/packages/dal/pydal/adapters/base.py", line 1364, in represent\n    return str(long(obj))\nValueError: invalid literal for long() with base 10: \'UHW\'\n'
p11
s.